<html>
    <head>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            #map {
                height: 400px;
                width: 100%;
                margin-bottom: 20px;
                display: none; /* Hide map initially */
            }
            .map-container {
                margin-bottom: 20px;
            }
        </style>
    </head>
    <body>
        <h1>Waypoints</h1>

        <h2>Corryong</h2>

        <div class="map-container">
            <button class="primary" id="load-map">
                Show Corryong Waypoints Map
            </button>
            <div id="map"></div>
        </div>

        <ul>
            <li>
                <a href="Corryong 2021 waypoints OZiexplorer.wpt"
                    >Corryong 2021 waypoints OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.cup"
                    >Corryong 2021 waypoints.cup</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.gpx"
                    >Corryong 2021 waypoints.gpx</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.kml"
                    >Corryong 2021 waypoints.kml</a
                >
            </li>
        </ul>

        <h2>Rest of Victoria</h2>
        <ul>
            <li>
                <a href="bigk wpt file 241117 OZiexplorer.wpt"
                    >bigk wpt file 241117 OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="bigk wpt file 241117.gpx">bigk wpt file 241117.gpx</a>
            </li>
            <li><a href="birchip.wpt">birchip.wpt</a></li>
            <li><a href="westvic.wpt">westvic.wpt</a></li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.wpt"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in WPT format</a
                >
            </li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.kml"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in KML format</a
                >
            </li>
        </ul>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            document
                .getElementById("load-map")
                .addEventListener("click", function () {
                    this.textContent = "Loading...";
                    this.disabled = true;
                    
                    // Show the map container
                    document.getElementById('map').style.display = 'block';

                    // Initialize the map
                    window.map = L.map("map").setView([-36.19, 147.89], 10); // Approximate Corryong coordinates
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer(
                        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                        {
                            attribution:
                                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        }
                    ).addTo(window.map);
                    
                    // Load the KML file
                    fetch("Corryong 2021 waypoints.kml")
                        .then((response) => response.text())
                        .then((kmlData) => {
                            // Parse the KML data
                            const parser = new DOMParser();
                            const kml = parser.parseFromString(
                                kmlData,
                                "text/xml"
                            );

                            // Extract waypoints from the KML file
                            const placemarks =
                                kml.getElementsByTagName("Placemark");

                            for (let i = 0; i < placemarks.length; i++) {
                                const placemark = placemarks[i];
                                
                                // Get the name from name tag
                                const name =
                                    placemark.getElementsByTagName("name")[0]
                                        ?.textContent || "Unnamed";
                                const desc =
                                    placemark.getElementsByTagName(
                                        "description"
                                    )[0]?.textContent || "";
                                const point =
                                    placemark.getElementsByTagName("Point")[0];

                                if (point) {
                                    const coords =
                                        point.getElementsByTagName(
                                            "coordinates"
                                        )[0]?.textContent || "";
                                    if (coords) {
                                        const [longitude, latitude, altitude] =
                                            coords
                                                .trim()
                                                .split(",")
                                                .map(parseFloat);

                                        // Create marker
                                        const marker = L.marker([
                                            latitude,
                                            longitude
                                        ])
                                            .addTo(window.map)
                                            .bindPopup(
                                                `<b>${name}</b><br>${desc}`
                                            );
                                    }
                                }
                            }

                            // A brief timeout to ensure map renders properly after showing
                            setTimeout(function() {
                                window.map.invalidateSize();
                            }, 100);

                            // Update button state
                            document.getElementById("load-map").textContent =
                                "Map Loaded";
                        })
                        .catch((error) => {
                            console.error("Error loading KML:", error);
                            document.getElementById("load-map").textContent =
                                "Error Loading Map";
                            document.getElementById("load-map").disabled =
                                false;
                        });
                });
        </script>
    </body>
</html>