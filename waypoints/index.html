<html>
    <head>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            #map {
                height: 400px;
                width: 100%;
                margin-bottom: 20px;
                display: none; /* Hide map initially */
            }
            .map-container {
                margin-bottom: 20px;
            }
            /* Style for waypoint labels */
            .waypoint-label {
                background: rgba(255, 255, 255, 0.7);
                border: none;
                border-radius: 3px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                padding: 1px 4px;
                font-size: 11px;
                white-space: nowrap;
                pointer-events: none;
            }
            /* Map control style */
            .map-type-control {
                background: white;
                padding: 5px 10px;
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                cursor: pointer;
            }
            .map-type-control:hover {
                background: #f4f4f4;
            }
            /* X marker style */
            .x-marker {
                color: white;
                font-weight: bold;
                text-shadow: 
                    -1px -1px 0 #000,
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000;
                font-size: 16px;
            }
        </style>
    </head>
    <body>
        <h1>Waypoints</h1>

        <h2>Corryong</h2>

        <div class="map-container">
            <button class="primary" id="load-map">
                Show Corryong Waypoints Map
            </button>
            <div id="map"></div>
        </div>

        <ul>
            <li>
                <a href="Corryong 2021 waypoints OZiexplorer.wpt"
                    >Corryong 2021 waypoints OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.cup"
                    >Corryong 2021 waypoints.cup</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.gpx"
                    >Corryong 2021 waypoints.gpx</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.kml"
                    >Corryong 2021 waypoints.kml</a
                >
            </li>
        </ul>

        <h2>Rest of Victoria</h2>
        <ul>
            <li>
                <a href="bigk wpt file 241117 OZiexplorer.wpt"
                    >bigk wpt file 241117 OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="bigk wpt file 241117.gpx">bigk wpt file 241117.gpx</a>
            </li>
            <li><a href="birchip.wpt">birchip.wpt</a></li>
            <li><a href="westvic.wpt">westvic.wpt</a></li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.wpt"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in WPT format</a
                >
            </li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.kml"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in KML format</a
                >
            </li>
        </ul>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            document
                .getElementById("load-map")
                .addEventListener("click", function () {
                    this.textContent = "Loading...";
                    this.disabled = true;
                    
                    // Show the map container
                    document.getElementById('map').style.display = 'block';

                    // Initialize the map
                    window.map = L.map("map").setView([-36.19, 147.89], 10); // Approximate Corryong coordinates
                    
                    // Define base map layers
                    const satelliteLayer = L.tileLayer(
                        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                            maxZoom: 18
                        }
                    );
                    
                    const streetLayer = L.tileLayer(
                        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }
                    );
                    
                    // Add satellite layer to map by default
                    satelliteLayer.addTo(window.map);
                    
                    // Add a simple map type control
                    const mapTypeControl = L.control({position: 'topright'});
                    
                    mapTypeControl.onAdd = function() {
                        const div = L.DomUtil.create('div', 'map-type-control');
                        div.innerHTML = 'Switch to Street Map';
                        div.onclick = function() {
                            if (window.map.hasLayer(satelliteLayer)) {
                                window.map.removeLayer(satelliteLayer);
                                window.map.addLayer(streetLayer);
                                div.innerHTML = 'Switch to Satellite Map';
                            } else {
                                window.map.removeLayer(streetLayer);
                                window.map.addLayer(satelliteLayer);
                                div.innerHTML = 'Switch to Street Map';
                            }
                        };
                        return div;
                    };
                    
                    mapTypeControl.addTo(window.map);
                    
                    // Load the KML file
                    fetch("Corryong 2021 waypoints.kml")
                        .then((response) => response.text())
                        .then((kmlData) => {
                            // Parse the KML data
                            const parser = new DOMParser();
                            const kml = parser.parseFromString(
                                kmlData,
                                "text/xml"
                            );

                            // Extract waypoints from the KML file
                            const placemarks =
                                kml.getElementsByTagName("Placemark");

                            for (let i = 0; i < placemarks.length; i++) {
                                const placemark = placemarks[i];
                                
                                // Get the name from name tag
                                const name =
                                    placemark.getElementsByTagName("name")[0]
                                        ?.textContent || "Unnamed";
                                const desc =
                                    placemark.getElementsByTagName(
                                        "description"
                                    )[0]?.textContent || "";
                                const point =
                                    placemark.getElementsByTagName("Point")[0];

                                if (point) {
                                    const coords =
                                        point.getElementsByTagName(
                                            "coordinates"
                                        )[0]?.textContent || "";
                                    if (coords) {
                                        const [longitude, latitude, altitude] =
                                            coords
                                                .trim()
                                                .split(",")
                                                .map(parseFloat);
                                        
                                        // Create label icon
                                        const labelIcon = L.divIcon({
                                            className: 'waypoint-label',
                                            html: name,
                                            iconSize: [100, 20],
                                            iconAnchor: [50, 10]
                                        });

                                        // Create simple dot marker instead of X
                                        const dotMarker = L.circleMarker([latitude, longitude], {
                                            radius: 4,
                                            fillColor: '#fff',
                                            color: '#000',
                                            weight: 1,
                                            opacity: 1,
                                            fillOpacity: 1
                                        })
                                        .addTo(window.map)
                                        .bindPopup(`<b>${name}</b><br>${desc}`);
                                        
                                        // Add label
                                        L.marker([latitude, longitude], {
                                            icon: labelIcon,
                                            interactive: false,
                                            keyboard: false
                                        }).addTo(window.map);
                                    }
                                }
                            }

                            // A brief timeout to ensure map renders properly after showing
                            setTimeout(function() {
                                window.map.invalidateSize();
                            }, 100);

                            // Update button state
                            document.getElementById("load-map").textContent =
                                "Map Loaded";
                        })
                        .catch((error) => {
                            console.error("Error loading KML:", error);
                            document.getElementById("load-map").textContent =
                                "Error Loading Map";
                            document.getElementById("load-map").disabled =
                                false;
                        });
                });
        </script>
    </body>
</html>