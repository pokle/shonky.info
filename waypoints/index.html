<html>
    <head>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            #map {
                height: 400px;
                width: 100%;
                margin-bottom: 20px;
                display: none; /* Hide map initially */
            }
            .map-container {
                margin-bottom: 20px;
            }
            /* Style for waypoint labels */
            .waypoint-label {
                background: transparent;
                border: none;
                padding: 1px 4px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                cursor: pointer;
                color: black;
                text-shadow: 
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
                transition: opacity 0.3s;
            }
            
            /* Dimmed label when not in route */
            .waypoint-label-dimmed {
                background: transparent;
                opacity: 0.7;
                border: none;
                padding: 1px 4px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                cursor: pointer;
                color: black;
                text-shadow: 
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
            }
            
            /* Active label in route */
            .waypoint-label-active {
                background: transparent;
                border: none;
                padding: 1px 4px;
                font-size: 12px;
                font-weight: bold;
                white-space: nowrap;
                cursor: pointer;
                color: #ff4500;
                text-shadow: 
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
                z-index: 1000 !important;
            }
            
            /* Last point in route styling (indicates it can be removed) */
            .waypoint-label-last {
                background: transparent;
                border: none;
                padding: 1px 4px;
                font-size: 12px;
                font-weight: bold;
                white-space: nowrap;
                cursor: not-allowed; /* Indicates removal */
                color: #ff4500;
                text-shadow: 
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
                z-index: 1000 !important;
            }
            
            /* Non-interactive labels (like circle radius) */
            .waypoint-label-static {
                background: transparent;
                border: none;
                padding: 1px 4px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                pointer-events: none;
                color: #3388ff;
                text-shadow: 
                    -1px -1px 0 #fff,
                    1px -1px 0 #fff,
                    -1px 1px 0 #fff,
                    1px 1px 0 #fff;
            }
            /* Map control style */
            .map-type-control {
                background: white;
                padding: 5px 10px;
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                cursor: pointer;
            }
            .map-type-control:hover {
                background: #f4f4f4;
            }
            /* X marker style */
            .x-marker {
                color: white;
                font-weight: bold;
                text-shadow: 
                    -1px -1px 0 #000,
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000;
                font-size: 16px;
            }
            /* Route planning controls */
            .route-planning-control {
                background: white;
                padding: 10px;
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                margin-bottom: 5px;
            }
            
            .route-points-container {
                margin: 10px 0;
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid #eee;
                border-radius: 4px;
                padding: 5px;
            }
            
            .route-points-container h5 {
                margin-top: 0;
                margin-bottom: 8px;
            }
            
            .route-point-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0;
                border-bottom: 1px solid #eee;
            }
            
            .route-point-item:last-child {
                border-bottom: none;
            }
            
            .route-point-info {
                flex-grow: 1;
            }
            
            .route-point-name {
                font-weight: bold;
            }
            
            .route-point-distance {
                color: #ff4500;
                font-size: 0.9em;
            }
            
            .route-point-remove {
                color: #ff4500;
                cursor: pointer;
                font-weight: bold;
                font-size: 16px;
                background: none;
                border: none;
                padding: 2px 8px;
                margin-left: 5px;
                border-radius: 3px;
                line-height: 1;
            }
            
            .route-point-remove:hover {
                background-color: #ffeeee;
            }
            .distance-label {
                background: rgba(255, 69, 0, 0.75); /* #ff4500 with opacity */
                color: white;
                border: 1px solid #ff4500;
                border-radius: 3px;
                padding: 2px 6px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                pointer-events: none;
                z-index: 1000;
                text-align: center;
                display: flex;
                justify-content: center;
                align-items: center;
                min-width: 50px;
            }
            .selected-waypoint {
                fill: #ff4500;
                stroke: #000;
                stroke-width: 1;
                r: 6;
            }
            
            /* Special styling for the last point in route */
            .last-point-hover {
                fill: #ff0000;
                stroke: #000;
                stroke-width: 2;
                r: 7;
            }
        </style>
    </head>
    <body>
        <h1>Waypoints</h1>

        <h2>Corryong</h2>

        <div class="map-container">
            <button class="primary" id="load-map">
                Show Corryong Waypoints Map
            </button>
            <div id="map"></div>
            <div class="route-planning-control" id="route-control" style="display: none;">
                <h4>Route Planning</h4>
                <p>Starting from: <span id="route-start"></span></p>
                <p>Total Distance: <span id="total-distance">0.0 km</span></p>
                
                <div class="route-points-container">
                    <h5>Route Points:</h5>
                    <div id="route-points-list">
                        <!-- Route points will be added here dynamically -->
                    </div>
                </div>
                
                <button id="reset-route" class="secondary">Start Again</button>
            </div>
        </div>

        <ul>
            <li>
                <a href="Corryong 2021 waypoints OZiexplorer.wpt"
                    >Corryong 2021 waypoints OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.cup"
                    >Corryong 2021 waypoints.cup</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.gpx"
                    >Corryong 2021 waypoints.gpx</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.kml"
                    >Corryong 2021 waypoints.kml</a
                >
            </li>
        </ul>

        <h2>Rest of Victoria</h2>
        <ul>
            <li>
                <a href="bigk wpt file 241117 OZiexplorer.wpt"
                    >bigk wpt file 241117 OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="bigk wpt file 241117.gpx">bigk wpt file 241117.gpx</a>
            </li>
            <li><a href="birchip.wpt">birchip.wpt</a></li>
            <li><a href="westvic.wpt">westvic.wpt</a></li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.wpt"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in WPT format</a
                >
            </li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.kml"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in KML format</a
                >
            </li>
        </ul>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            document
                .getElementById("load-map")
                .addEventListener("click", function () {
                    this.textContent = "Loading...";
                    this.disabled = true;
                    
                    // Show the map container
                    document.getElementById('map').style.display = 'block';

                    // Initialize the map
                    window.map = L.map("map").setView([-36.19, 147.89], 10); // Approximate Corryong coordinates
                    
                    // Define base map layers
                    const satelliteLayer = L.tileLayer(
                        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                            maxZoom: 18
                        }
                    );
                    
                    const streetLayer = L.tileLayer(
                        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }
                    );
                    
                    // Add satellite layer to map by default
                    satelliteLayer.addTo(window.map);
                    
                    // Add a simple map type control
                    const mapTypeControl = L.control({position: 'topright'});
                    
                    mapTypeControl.onAdd = function() {
                        const div = L.DomUtil.create('div', 'map-type-control');
                        div.innerHTML = 'Switch to Street Map';
                        div.onclick = function() {
                            if (window.map.hasLayer(satelliteLayer)) {
                                window.map.removeLayer(satelliteLayer);
                                window.map.addLayer(streetLayer);
                                div.innerHTML = 'Switch to Satellite Map';
                            } else {
                                window.map.removeLayer(streetLayer);
                                window.map.addLayer(satelliteLayer);
                                div.innerHTML = 'Switch to Street Map';
                            }
                        };
                        return div;
                    };
                    
                    mapTypeControl.addTo(window.map);
                    
                    // Load the KML file
                    fetch("Corryong 2021 waypoints.kml")
                        .then((response) => response.text())
                        .then((kmlData) => {
                            // Parse the KML data
                            const parser = new DOMParser();
                            const kml = parser.parseFromString(
                                kmlData,
                                "text/xml"
                            );

                            // Extract waypoints from the KML file
                            const placemarks =
                                kml.getElementsByTagName("Placemark");
                            
                            // Initialize route planning variables
                            const waypointMap = new Map(); // To store waypoints by name
                            let routePoints = []; // To store selected waypoints for the route
                            let routePolylines = []; // To store the polylines between waypoints
                            let routeDistanceLabels = []; // To store distance labels
                            let segmentDistances = []; // To store distance of each segment
                            let totalDistance = 0; // Total route distance
                            let elliottMarker = null; // Reference to the ELLIOT marker
                            let elliotCircle = null; // 5km radius circle around ELLIOT
                            let isRoutingStarted = false;
                            
                            // For managing label styles
                            const labelMarkers = new Map(); // Map of name to label marker
                            
                            // Function to calculate distance between two points in kilometers
                            function calculateDistance(lat1, lon1, lat2, lon2) {
                                const R = 6371; // Radius of the earth in km
                                const dLat = (lat2 - lat1) * Math.PI / 180;
                                const dLon = (lon2 - lon1) * Math.PI / 180;
                                const a = 
                                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                const distance = R * c; // Distance in km
                                return distance;
                            }
                            
                            // Function to create distance label
                            function createDistanceLabel(lat1, lon1, lat2, lon2, distance) {
                                // Calculate midpoint for label placement
                                const midLat = (lat1 + lat2) / 2;
                                const midLon = (lon1 + lon2) / 2;
                                
                                // Create label icon - matching the line color (#ff4500)
                                const distText = distance.toFixed(1) + ' km';
                                const distanceIcon = L.divIcon({
                                    className: 'distance-label',
                                    html: `<div style="width:100%;text-align:center;">${distText}</div>`,
                                    iconSize: [80, 24],
                                    iconAnchor: [40, 12]
                                });
                                
                                // Create and return the marker with high z-index to stay on top
                                return L.marker([midLat, midLon], {
                                    icon: distanceIcon,
                                    interactive: false,
                                    keyboard: false,
                                    zIndexOffset: 1000 // Ensure distance labels stay on top
                                }).addTo(window.map);
                            }
                            
                            // Function to add a waypoint to the route
                            function addWaypointToRoute(marker, lat, lon, name, altitude) {
                                // Check if this is the most recently added point
                                if (routePoints.length > 0) {
                                    const lastPoint = routePoints[routePoints.length - 1];
                                    // If clicking on the same point again, remove it
                                    if (lastPoint.name === name && lastPoint.lat === lat && lastPoint.lon === lon) {
                                        // Remove the last point
                                        removeRoutePoint(routePoints.length - 1);
                                        return;
                                    }
                                }
                                
                                // If this is the first point or routing hasn't started yet
                                if (routePoints.length === 0 || !isRoutingStarted) {
                                    // Start the route
                                    isRoutingStarted = true;
                                    document.getElementById('route-control').style.display = 'block';
                                    
                                    // Highlight the marker
                                    marker.setStyle({
                                        radius: 6,
                                        fillColor: '#ff4500',
                                        color: '#000'
                                    });
                                    
                                    // Add the point to our route
                                    routePoints.push({
                                        marker: marker,
                                        lat: lat,
                                        lon: lon,
                                        name: name,
                                        altitude: altitude
                                    });
                                    
                                    // Update the route start display
                                    document.getElementById('route-start').textContent = name;
                                    
                                    // Update label styles - first dim all labels
                                    updateLabelStyles();
                                    
                                    // Initialize the route points list
                                    updateRoutePointsList();
                                    
                                    return;
                                }
                                
                                // Get the previous point
                                const prevPoint = routePoints[routePoints.length - 1];
                                
                                // Calculate distance
                                const segmentDistance = calculateDistance(
                                    prevPoint.lat, prevPoint.lon, lat, lon
                                );
                                
                                // Store the segment distance
                                segmentDistances.push(segmentDistance);
                                
                                // Update total distance
                                totalDistance += segmentDistance;
                                document.getElementById('total-distance').textContent = totalDistance.toFixed(1) + ' km';
                                
                                // Create a line from the previous point to this one
                                const polyline = L.polyline([
                                    [prevPoint.lat, prevPoint.lon],
                                    [lat, lon]
                                ], {
                                    color: '#ff4500',
                                    weight: 3,
                                    opacity: 0.7
                                }).addTo(window.map);
                                
                                // Add distance label
                                const distanceLabel = createDistanceLabel(
                                    prevPoint.lat, prevPoint.lon, lat, lon, segmentDistance
                                );
                                
                                // Highlight the marker
                                marker.setStyle({
                                    radius: 6,
                                    fillColor: '#ff4500',
                                    color: '#000'
                                });
                                
                                // Store the new point, polyline, and label
                                routePoints.push({
                                    marker: marker,
                                    lat: lat,
                                    lon: lon,
                                    name: name,
                                    altitude: altitude
                                });
                                routePolylines.push(polyline);
                                routeDistanceLabels.push(distanceLabel);
                                
                                // Update label styles to highlight active waypoints and dim others
                                updateLabelStyles();
                                
                                // Update the route points list in the UI
                                updateRoutePointsList();
                            }
                            
                            // Function to update label styles based on route
                            function updateLabelStyles() {
                                // If no route is active, reset all labels to normal
                                if (!isRoutingStarted || routePoints.length === 0) {
                                    labelMarkers.forEach((data, name) => {
                                        // Create a new icon with the original class
                                        const newIcon = L.divIcon({
                                            className: 'waypoint-label',
                                            html: data.icon.options.html,
                                            iconSize: data.icon.options.iconSize,
                                            iconAnchor: data.icon.options.iconAnchor
                                        });
                                        data.marker.setIcon(newIcon);
                                        data.active = false;
                                    });
                                    return;
                                }
                                
                                // Get active waypoint names
                                const activeWaypoints = routePoints.map(point => point.name);
                                
                                // Get the last point in the route
                                const lastPointName = routePoints[routePoints.length - 1].name;
                                
                                // Update all labels
                                labelMarkers.forEach((data, name) => {
                                    let className;
                                    if (name === lastPointName) {
                                        // Last point in route - special styling to indicate it can be removed
                                        className = 'waypoint-label-last';
                                        data.active = true;
                                        data.marker.setZIndexOffset(1000); // Move to front
                                    } else if (activeWaypoints.includes(name)) {
                                        // Active waypoint
                                        className = 'waypoint-label-active';
                                        data.active = true;
                                        data.marker.setZIndexOffset(1000); // Move to front
                                    } else {
                                        // Dim non-active waypoints
                                        className = 'waypoint-label-dimmed';
                                        data.active = false;
                                        data.marker.setZIndexOffset(100);
                                    }
                                    
                                    // Create a new icon with the updated class
                                    const newIcon = L.divIcon({
                                        className: className,
                                        html: data.icon.options.html,
                                        iconSize: data.icon.options.iconSize,
                                        iconAnchor: data.icon.options.iconAnchor
                                    });
                                    data.marker.setIcon(newIcon);
                                });
                            }
                            
                            // Function to update the route points list in the UI
                            function updateRoutePointsList() {
                                const routeListElement = document.getElementById('route-points-list');
                                routeListElement.innerHTML = '';
                                
                                if (routePoints.length === 0) {
                                    routeListElement.innerHTML = '<div class="route-point-item">No points in route yet</div>';
                                    return;
                                }
                                
                                // Add each point to the list
                                routePoints.forEach((point, index) => {
                                    const pointElement = document.createElement('div');
                                    pointElement.className = 'route-point-item';
                                    
                                    const infoElement = document.createElement('div');
                                    infoElement.className = 'route-point-info';
                                    
                                    const nameElement = document.createElement('span');
                                    nameElement.className = 'route-point-name';
                                    nameElement.textContent = point.name;
                                    
                                    infoElement.appendChild(nameElement);
                                    
                                    // Add distance info if not the first point
                                    if (index > 0) {
                                        const distElement = document.createElement('div');
                                        distElement.className = 'route-point-distance';
                                        distElement.textContent = `+${segmentDistances[index-1].toFixed(1)} km`;
                                        infoElement.appendChild(distElement);
                                    }
                                    
                                    pointElement.appendChild(infoElement);
                                    
                                    // Add remove button
                                    const removeButton = document.createElement('button');
                                    removeButton.className = 'route-point-remove';
                                    removeButton.innerHTML = '&times;';  // HTML entity for multiplication sign/X
                                    removeButton.setAttribute('title', 'Remove point');
                                    removeButton.setAttribute('data-index', index);
                                    removeButton.addEventListener('click', function() {
                                        removeRoutePoint(index);
                                    });
                                    
                                    pointElement.appendChild(removeButton);
                                    routeListElement.appendChild(pointElement);
                                });
                            }
                            
                            // Function to remove a point from the route
                            function removeRoutePoint(index) {
                                // Ignore if route is empty
                                if (routePoints.length === 0) return;
                                
                                // Can't remove first point if it's the only one
                                if (routePoints.length === 1) {
                                    resetRoute();
                                    return;
                                }
                                
                                // Get the point to remove
                                const pointToRemove = routePoints[index];
                                
                                // Reset that point's marker style
                                pointToRemove.marker.setStyle({
                                    radius: 4,
                                    fillColor: '#fff',
                                    color: '#000',
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 1
                                });
                                
                                // Remove the point from the route
                                routePoints.splice(index, 1);
                                
                                // If we're removing the first point, we need special handling
                                if (index === 0) {
                                    // Update the starting point display
                                    document.getElementById('route-start').textContent = routePoints[0].name;
                                }
                                
                                // Remove all polylines and distance labels from map and rebuild
                                routePolylines.forEach(polyline => window.map.removeLayer(polyline));
                                routeDistanceLabels.forEach(label => window.map.removeLayer(label));
                                
                                // Clear arrays
                                routePolylines = [];
                                routeDistanceLabels = [];
                                segmentDistances = [];
                                
                                // Reset total distance and recalculate
                                totalDistance = 0;
                                
                                // Rebuild the route connections
                                for (let i = 1; i < routePoints.length; i++) {
                                    const prevPoint = routePoints[i-1];
                                    const currPoint = routePoints[i];
                                    
                                    // Calculate distance between these points
                                    const segmentDistance = calculateDistance(
                                        prevPoint.lat, prevPoint.lon, currPoint.lat, currPoint.lon
                                    );
                                    
                                    // Store the segment distance
                                    segmentDistances.push(segmentDistance);
                                    
                                    // Add to total distance
                                    totalDistance += segmentDistance;
                                    
                                    // Create a line between points
                                    const polyline = L.polyline([
                                        [prevPoint.lat, prevPoint.lon],
                                        [currPoint.lat, currPoint.lon]
                                    ], {
                                        color: '#ff4500',
                                        weight: 3,
                                        opacity: 0.7
                                    }).addTo(window.map);
                                    
                                    // Add distance label
                                    const distLabel = createDistanceLabel(
                                        prevPoint.lat, prevPoint.lon, currPoint.lat, currPoint.lon, segmentDistance
                                    );
                                    
                                    // Save to arrays
                                    routePolylines.push(polyline);
                                    routeDistanceLabels.push(distLabel);
                                }
                                
                                // Update total distance display
                                document.getElementById('total-distance').textContent = totalDistance.toFixed(1) + ' km';
                                
                                // Update label styles
                                updateLabelStyles();
                                
                                // Update the route points list in the UI
                                updateRoutePointsList();
                            }
                            
                            // Function to reset the route
                            function resetRoute() {
                                // Remove polylines and distance labels from map
                                routePolylines.forEach(polyline => window.map.removeLayer(polyline));
                                routeDistanceLabels.forEach(label => window.map.removeLayer(label));
                                
                                // Reset marker styles
                                routePoints.forEach(point => {
                                    point.marker.setStyle({
                                        radius: 4,
                                        fillColor: '#fff',
                                        color: '#000',
                                        weight: 1,
                                        opacity: 1,
                                        fillOpacity: 1
                                    });
                                });
                                
                                // Clear arrays
                                routePoints = [];
                                routePolylines = [];
                                routeDistanceLabels = [];
                                segmentDistances = [];
                                
                                // Reset total distance
                                totalDistance = 0;
                                document.getElementById('total-distance').textContent = '0.0 km';
                                document.getElementById('route-start').textContent = '';
                                
                                // Reset routing state
                                isRoutingStarted = false;
                                document.getElementById('route-control').style.display = 'none';
                                
                                // Reset all label styles
                                updateLabelStyles();
                                
                                // Update the route points list
                                updateRoutePointsList();
                                
                                // Make sure ELLIOT circle is still visible
                                if (elliotCircle && !window.map.hasLayer(elliotCircle)) {
                                    elliotCircle.addTo(window.map);
                                }
                            }
                            
                            // Set up reset button event listener
                            document.getElementById('reset-route').addEventListener('click', resetRoute);

                            for (let i = 0; i < placemarks.length; i++) {
                                const placemark = placemarks[i];
                                
                                // Get the name from name tag
                                const name =
                                    placemark.getElementsByTagName("name")[0]
                                        ?.textContent || "Unnamed";
                                const desc =
                                    placemark.getElementsByTagName(
                                        "description"
                                    )[0]?.textContent || "";
                                const point =
                                    placemark.getElementsByTagName("Point")[0];

                                if (point) {
                                    const coords =
                                        point.getElementsByTagName(
                                            "coordinates"
                                        )[0]?.textContent || "";
                                    if (coords) {
                                        const [longitude, latitude, altitude] =
                                            coords
                                                .trim()
                                                .split(",")
                                                .map(parseFloat);
                                        
                                        // Format altitude display if available
                                        const altDisplay = altitude && altitude > 0 ? ` (${Math.round(altitude)}m)` : '';
                                        
                                        // Create label icon that auto-sizes to content
                                        const labelIcon = L.divIcon({
                                            className: 'waypoint-label',
                                            html: `${name}${altDisplay}`,
                                            iconSize: null, // Auto-size based on content
                                            iconAnchor: [0, 10] // Anchored at the bottom-left of the text
                                        });

                                        // Create simple dot marker instead of X
                                        const dotMarker = L.circleMarker([latitude, longitude], {
                                            radius: 4,
                                            fillColor: '#fff',
                                            color: '#000',
                                            weight: 1,
                                            opacity: 1,
                                            fillOpacity: 1
                                        })
                                        .addTo(window.map)
                                        .bindPopup(`<b>${name}</b>${altDisplay}<br>${desc}`);
                                        
                                        // Store waypoint data for route planning
                                        waypointMap.set(name, {
                                            marker: dotMarker,
                                            lat: latitude,
                                            lon: longitude,
                                            name: name,
                                            desc: desc,
                                            altitude: altitude
                                        });
                                        
                                        // Add click event for route planning
                                        dotMarker.on('click', function() {
                                            addWaypointToRoute(dotMarker, latitude, longitude, name, altitude);
                                        });
                                        
                                        // Add mouse events to change cursor when hovering over the most recently added point
                                        dotMarker.on('mouseover', function() {
                                            if (routePoints.length > 0 && routePoints[routePoints.length - 1].name === name) {
                                                // Last point in route - use not-allowed cursor to indicate removal
                                                L.DomUtil.addClass(dotMarker._path, 'last-point-hover');
                                                dotMarker._path.style.cursor = 'not-allowed';
                                            }
                                        });
                                        
                                        dotMarker.on('mouseout', function() {
                                            L.DomUtil.removeClass(dotMarker._path, 'last-point-hover');
                                            dotMarker._path.style.cursor = '';
                                        });
                                        
                                        // Save reference to ELLIOT marker
                                        if (name === "ELLIOT") {
                                            elliottMarker = dotMarker;
                                            
                                            // Add a 5km radius circle around ELLIOT (competition start circle)
                                            elliotCircle = L.circle([latitude, longitude], {
                                                radius: 5000, // 5km in meters
                                                color: '#3388ff',
                                                fillColor: '#3388ff',
                                                fillOpacity: 0.1,
                                                weight: 2,
                                                dashArray: '5,5'
                                            }).addTo(window.map);
                                            
                                            // Add a radius label
                                            const radiusLabelIcon = L.divIcon({
                                                className: 'waypoint-label-static',
                                                html: '5km radius (competition start)',
                                                iconSize: null, // Auto-size based on content
                                                iconAnchor: [0, 10] // Anchored at the bottom-left of the text
                                            });
                                            
                                            // Position label slightly north of the circle edge
                                            const labelLat = latitude + (5 / 111.32); // ~5km north
                                            L.marker([labelLat, longitude], {
                                                icon: radiusLabelIcon,
                                                interactive: false,
                                                keyboard: false
                                            }).addTo(window.map);
                                        }
                                        
                                        // Create clickable label with higher z-index to appear above other markers
                                        const labelMarker = L.marker([latitude, longitude], {
                                            icon: labelIcon,
                                            keyboard: false,
                                            zIndexOffset: 100 // Higher than default (0)
                                        }).addTo(window.map);
                                        
                                        // Store reference to the label marker
                                        labelMarkers.set(name, {
                                            marker: labelMarker,
                                            icon: labelIcon,
                                            active: false
                                        });
                                        
                                        // Add click event to the label for route planning
                                        labelMarker.on('click', function() {
                                            addWaypointToRoute(dotMarker, latitude, longitude, name, altitude);
                                        });
                                        
                                        // Add mouse events to set cursor on label hover
                                        labelMarker.on('mouseover', function() {
                                            if (routePoints.length > 0 && routePoints[routePoints.length - 1].name === name) {
                                                // Use CSS to show not-allowed cursor via waypoint-label-last class in updateLabelStyles
                                            }
                                        });
                                    }
                                }
                            }

                            // A brief timeout to ensure map renders properly after showing
                            setTimeout(function() {
                                window.map.invalidateSize();
                            }, 100);

                            // Remove the load button entirely
                            document.getElementById("load-map").remove();
                        })
                        .catch((error) => {
                            console.error("Error loading KML:", error);
                            const loadButton = document.getElementById("load-map");
                            if (loadButton) {
                                loadButton.textContent = "Error Loading Map";
                                loadButton.disabled = false;
                            }
                        });
                });
        </script>
    </body>
</html>