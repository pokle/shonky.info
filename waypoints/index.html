<html>
    <head>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            #map {
                height: 400px;
                width: 100%;
                margin-bottom: 20px;
                display: none; /* Hide map initially */
            }
            .map-container {
                margin-bottom: 20px;
            }
            /* Style for waypoint labels */
            .waypoint-label {
                background: rgba(255, 255, 255, 0.7);
                border: none;
                border-radius: 3px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                padding: 1px 4px;
                font-size: 11px;
                white-space: nowrap;
                cursor: pointer;
                transition: opacity 0.3s;
            }
            
            /* Dimmed label when not in route */
            .waypoint-label-dimmed {
                background: rgba(255, 255, 255, 0.5);
                opacity: 0.6;
                border: none;
                border-radius: 3px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                padding: 1px 4px;
                font-size: 11px;
                white-space: nowrap;
                cursor: pointer;
            }
            
            /* Active label in route */
            .waypoint-label-active {
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 3px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                padding: 1px 4px;
                font-size: 11px;
                white-space: nowrap;
                font-weight: bold;
                cursor: pointer;
                z-index: 1000 !important;
            }
            
            /* Non-interactive labels (like circle radius) */
            .waypoint-label-static {
                background: rgba(255, 255, 255, 0.7);
                border: none;
                border-radius: 3px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                padding: 1px 4px;
                font-size: 11px;
                white-space: nowrap;
                pointer-events: none;
            }
            /* Map control style */
            .map-type-control {
                background: white;
                padding: 5px 10px;
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                cursor: pointer;
            }
            .map-type-control:hover {
                background: #f4f4f4;
            }
            /* X marker style */
            .x-marker {
                color: white;
                font-weight: bold;
                text-shadow: 
                    -1px -1px 0 #000,
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000;
                font-size: 16px;
            }
            /* Route planning controls */
            .route-planning-control {
                background: white;
                padding: 10px;
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                margin-bottom: 5px;
            }
            .distance-label {
                background: rgba(255, 69, 0, 0.75); /* #ff4500 with opacity */
                color: white;
                border: 1px solid #ff4500;
                border-radius: 3px;
                padding: 2px 6px;
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
                pointer-events: none;
                z-index: 1000;
                text-align: center;
                display: flex;
                justify-content: center;
                align-items: center;
                min-width: 50px;
            }
            .selected-waypoint {
                fill: #ff4500;
                stroke: #000;
                stroke-width: 1;
                r: 6;
            }
        </style>
    </head>
    <body>
        <h1>Waypoints</h1>

        <h2>Corryong</h2>

        <div class="map-container">
            <button class="primary" id="load-map">
                Show Corryong Waypoints Map
            </button>
            <div id="map"></div>
            <div class="route-planning-control" id="route-control" style="display: none;">
                <h4>Route Planning</h4>
                <p>Starting from: <span id="route-start"></span></p>
                <p>Total Distance: <span id="total-distance">0.0 km</span></p>
                <button id="reset-route" class="secondary">Start Again</button>
            </div>
        </div>

        <ul>
            <li>
                <a href="Corryong 2021 waypoints OZiexplorer.wpt"
                    >Corryong 2021 waypoints OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.cup"
                    >Corryong 2021 waypoints.cup</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.gpx"
                    >Corryong 2021 waypoints.gpx</a
                >
            </li>
            <li>
                <a href="Corryong 2021 waypoints.kml"
                    >Corryong 2021 waypoints.kml</a
                >
            </li>
        </ul>

        <h2>Rest of Victoria</h2>
        <ul>
            <li>
                <a href="bigk wpt file 241117 OZiexplorer.wpt"
                    >bigk wpt file 241117 OZiexplorer.wpt</a
                >
            </li>
            <li>
                <a href="bigk wpt file 241117.gpx">bigk wpt file 241117.gpx</a>
            </li>
            <li><a href="birchip.wpt">birchip.wpt</a></li>
            <li><a href="westvic.wpt">westvic.wpt</a></li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.wpt"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in WPT format</a
                >
            </li>
            <li>
                <a href="TPCVictoria2021-v1.0-swapped.kml"
                    >Turn Point Challenge Victoria 2021-v1.0 - names and
                    descriptions swapped - in KML format</a
                >
            </li>
        </ul>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script>
            document
                .getElementById("load-map")
                .addEventListener("click", function () {
                    this.textContent = "Loading...";
                    this.disabled = true;
                    
                    // Show the map container
                    document.getElementById('map').style.display = 'block';

                    // Initialize the map
                    window.map = L.map("map").setView([-36.19, 147.89], 10); // Approximate Corryong coordinates
                    
                    // Define base map layers
                    const satelliteLayer = L.tileLayer(
                        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                            maxZoom: 18
                        }
                    );
                    
                    const streetLayer = L.tileLayer(
                        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }
                    );
                    
                    // Add satellite layer to map by default
                    satelliteLayer.addTo(window.map);
                    
                    // Add a simple map type control
                    const mapTypeControl = L.control({position: 'topright'});
                    
                    mapTypeControl.onAdd = function() {
                        const div = L.DomUtil.create('div', 'map-type-control');
                        div.innerHTML = 'Switch to Street Map';
                        div.onclick = function() {
                            if (window.map.hasLayer(satelliteLayer)) {
                                window.map.removeLayer(satelliteLayer);
                                window.map.addLayer(streetLayer);
                                div.innerHTML = 'Switch to Satellite Map';
                            } else {
                                window.map.removeLayer(streetLayer);
                                window.map.addLayer(satelliteLayer);
                                div.innerHTML = 'Switch to Street Map';
                            }
                        };
                        return div;
                    };
                    
                    mapTypeControl.addTo(window.map);
                    
                    // Load the KML file
                    fetch("Corryong 2021 waypoints.kml")
                        .then((response) => response.text())
                        .then((kmlData) => {
                            // Parse the KML data
                            const parser = new DOMParser();
                            const kml = parser.parseFromString(
                                kmlData,
                                "text/xml"
                            );

                            // Extract waypoints from the KML file
                            const placemarks =
                                kml.getElementsByTagName("Placemark");
                            
                            // Initialize route planning variables
                            const waypointMap = new Map(); // To store waypoints by name
                            let routePoints = []; // To store selected waypoints for the route
                            let routePolylines = []; // To store the polylines between waypoints
                            let routeDistanceLabels = []; // To store distance labels
                            let totalDistance = 0; // Total route distance
                            let elliottMarker = null; // Reference to the ELLIOT marker
                            let elliotCircle = null; // 5km radius circle around ELLIOT
                            let isRoutingStarted = false;
                            
                            // For managing label styles
                            const labelMarkers = new Map(); // Map of name to label marker
                            
                            // Function to calculate distance between two points in kilometers
                            function calculateDistance(lat1, lon1, lat2, lon2) {
                                const R = 6371; // Radius of the earth in km
                                const dLat = (lat2 - lat1) * Math.PI / 180;
                                const dLon = (lon2 - lon1) * Math.PI / 180;
                                const a = 
                                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                const distance = R * c; // Distance in km
                                return distance;
                            }
                            
                            // Function to create distance label
                            function createDistanceLabel(lat1, lon1, lat2, lon2, distance) {
                                // Calculate midpoint for label placement
                                const midLat = (lat1 + lat2) / 2;
                                const midLon = (lon1 + lon2) / 2;
                                
                                // Create label icon - matching the line color (#ff4500)
                                const distText = distance.toFixed(1) + ' km';
                                const distanceIcon = L.divIcon({
                                    className: 'distance-label',
                                    html: `<div style="width:100%;text-align:center;">${distText}</div>`,
                                    iconSize: [80, 24],
                                    iconAnchor: [40, 12]
                                });
                                
                                // Create and return the marker with high z-index to stay on top
                                return L.marker([midLat, midLon], {
                                    icon: distanceIcon,
                                    interactive: false,
                                    keyboard: false,
                                    zIndexOffset: 1000 // Ensure distance labels stay on top
                                }).addTo(window.map);
                            }
                            
                            // Function to add a waypoint to the route
                            function addWaypointToRoute(marker, lat, lon, name, altitude) {
                                // If this is the first point or routing hasn't started yet
                                if (routePoints.length === 0 || !isRoutingStarted) {
                                    // Start the route
                                    isRoutingStarted = true;
                                    document.getElementById('route-control').style.display = 'block';
                                    
                                    // Highlight the marker
                                    marker.setStyle({
                                        radius: 6,
                                        fillColor: '#ff4500',
                                        color: '#000'
                                    });
                                    
                                    // Add the point to our route
                                    routePoints.push({
                                        marker: marker,
                                        lat: lat,
                                        lon: lon,
                                        name: name,
                                        altitude: altitude
                                    });
                                    
                                    // Update the route start display
                                    document.getElementById('route-start').textContent = name;
                                    
                                    // Update label styles - first dim all labels
                                    updateLabelStyles();
                                    
                                    return;
                                }
                                
                                // Get the previous point
                                const prevPoint = routePoints[routePoints.length - 1];
                                
                                // Calculate distance
                                const segmentDistance = calculateDistance(
                                    prevPoint.lat, prevPoint.lon, lat, lon
                                );
                                
                                // Update total distance
                                totalDistance += segmentDistance;
                                document.getElementById('total-distance').textContent = totalDistance.toFixed(1) + ' km';
                                
                                // Create a line from the previous point to this one
                                const polyline = L.polyline([
                                    [prevPoint.lat, prevPoint.lon],
                                    [lat, lon]
                                ], {
                                    color: '#ff4500',
                                    weight: 3,
                                    opacity: 0.7
                                }).addTo(window.map);
                                
                                // Add distance label
                                const distanceLabel = createDistanceLabel(
                                    prevPoint.lat, prevPoint.lon, lat, lon, segmentDistance
                                );
                                
                                // Highlight the marker
                                marker.setStyle({
                                    radius: 6,
                                    fillColor: '#ff4500',
                                    color: '#000'
                                });
                                
                                // Store the new point, polyline, and label
                                routePoints.push({
                                    marker: marker,
                                    lat: lat,
                                    lon: lon,
                                    name: name,
                                    altitude: altitude
                                });
                                routePolylines.push(polyline);
                                routeDistanceLabels.push(distanceLabel);
                                
                                // Update label styles to highlight active waypoints and dim others
                                updateLabelStyles();
                            }
                            
                            // Function to update label styles based on route
                            function updateLabelStyles() {
                                // If no route is active, reset all labels to normal
                                if (!isRoutingStarted || routePoints.length === 0) {
                                    labelMarkers.forEach((data, name) => {
                                        // Create a new icon with the original class
                                        const newIcon = L.divIcon({
                                            className: 'waypoint-label',
                                            html: data.icon.options.html,
                                            iconSize: data.icon.options.iconSize,
                                            iconAnchor: data.icon.options.iconAnchor
                                        });
                                        data.marker.setIcon(newIcon);
                                        data.active = false;
                                    });
                                    return;
                                }
                                
                                // Get active waypoint names
                                const activeWaypoints = routePoints.map(point => point.name);
                                
                                // Update all labels
                                labelMarkers.forEach((data, name) => {
                                    let className;
                                    if (activeWaypoints.includes(name)) {
                                        // Active waypoint
                                        className = 'waypoint-label-active';
                                        data.active = true;
                                        data.marker.setZIndexOffset(1000); // Move to front
                                    } else {
                                        // Dim non-active waypoints
                                        className = 'waypoint-label-dimmed';
                                        data.active = false;
                                        data.marker.setZIndexOffset(100);
                                    }
                                    
                                    // Create a new icon with the updated class
                                    const newIcon = L.divIcon({
                                        className: className,
                                        html: data.icon.options.html,
                                        iconSize: data.icon.options.iconSize,
                                        iconAnchor: data.icon.options.iconAnchor
                                    });
                                    data.marker.setIcon(newIcon);
                                });
                            }
                            
                            // Function to reset the route
                            function resetRoute() {
                                // Remove polylines and distance labels from map
                                routePolylines.forEach(polyline => window.map.removeLayer(polyline));
                                routeDistanceLabels.forEach(label => window.map.removeLayer(label));
                                
                                // Reset marker styles
                                routePoints.forEach(point => {
                                    point.marker.setStyle({
                                        radius: 4,
                                        fillColor: '#fff',
                                        color: '#000',
                                        weight: 1,
                                        opacity: 1,
                                        fillOpacity: 1
                                    });
                                });
                                
                                // Clear arrays
                                routePoints = [];
                                routePolylines = [];
                                routeDistanceLabels = [];
                                
                                // Reset total distance
                                totalDistance = 0;
                                document.getElementById('total-distance').textContent = '0.0 km';
                                document.getElementById('route-start').textContent = '';
                                
                                // Reset routing state
                                isRoutingStarted = false;
                                document.getElementById('route-control').style.display = 'none';
                                
                                // Reset all label styles
                                updateLabelStyles();
                                
                                // Make sure ELLIOT circle is still visible
                                if (elliotCircle && !window.map.hasLayer(elliotCircle)) {
                                    elliotCircle.addTo(window.map);
                                }
                            }
                            
                            // Set up reset button event listener
                            document.getElementById('reset-route').addEventListener('click', resetRoute);

                            for (let i = 0; i < placemarks.length; i++) {
                                const placemark = placemarks[i];
                                
                                // Get the name from name tag
                                const name =
                                    placemark.getElementsByTagName("name")[0]
                                        ?.textContent || "Unnamed";
                                const desc =
                                    placemark.getElementsByTagName(
                                        "description"
                                    )[0]?.textContent || "";
                                const point =
                                    placemark.getElementsByTagName("Point")[0];

                                if (point) {
                                    const coords =
                                        point.getElementsByTagName(
                                            "coordinates"
                                        )[0]?.textContent || "";
                                    if (coords) {
                                        const [longitude, latitude, altitude] =
                                            coords
                                                .trim()
                                                .split(",")
                                                .map(parseFloat);
                                        
                                        // Format altitude display if available
                                        const altDisplay = altitude && altitude > 0 ? ` (${Math.round(altitude)}m)` : '';
                                        
                                        // Create label icon
                                        const labelIcon = L.divIcon({
                                            className: 'waypoint-label',
                                            html: `${name}${altDisplay}`,
                                            iconSize: [130, 20],
                                            iconAnchor: [65, 10]
                                        });

                                        // Create simple dot marker instead of X
                                        const dotMarker = L.circleMarker([latitude, longitude], {
                                            radius: 4,
                                            fillColor: '#fff',
                                            color: '#000',
                                            weight: 1,
                                            opacity: 1,
                                            fillOpacity: 1
                                        })
                                        .addTo(window.map)
                                        .bindPopup(`<b>${name}</b>${altDisplay}<br>${desc}`);
                                        
                                        // Store waypoint data for route planning
                                        waypointMap.set(name, {
                                            marker: dotMarker,
                                            lat: latitude,
                                            lon: longitude,
                                            name: name,
                                            desc: desc,
                                            altitude: altitude
                                        });
                                        
                                        // Add click event for route planning
                                        dotMarker.on('click', function() {
                                            addWaypointToRoute(dotMarker, latitude, longitude, name, altitude);
                                        });
                                        
                                        // Save reference to ELLIOT marker
                                        if (name === "ELLIOT") {
                                            elliottMarker = dotMarker;
                                            
                                            // Add a 5km radius circle around ELLIOT (competition start circle)
                                            elliotCircle = L.circle([latitude, longitude], {
                                                radius: 5000, // 5km in meters
                                                color: '#3388ff',
                                                fillColor: '#3388ff',
                                                fillOpacity: 0.1,
                                                weight: 2,
                                                dashArray: '5,5'
                                            }).addTo(window.map);
                                            
                                            // Add a radius label
                                            const radiusLabelIcon = L.divIcon({
                                                className: 'waypoint-label-static',
                                                html: '5km radius (competition start)',
                                                iconSize: [150, 20],
                                                iconAnchor: [75, 10]
                                            });
                                            
                                            // Position label slightly north of the circle edge
                                            const labelLat = latitude + (5 / 111.32); // ~5km north
                                            L.marker([labelLat, longitude], {
                                                icon: radiusLabelIcon,
                                                interactive: false,
                                                keyboard: false
                                            }).addTo(window.map);
                                        }
                                        
                                        // Create clickable label with higher z-index to appear above other markers
                                        const labelMarker = L.marker([latitude, longitude], {
                                            icon: labelIcon,
                                            keyboard: false,
                                            zIndexOffset: 100 // Higher than default (0)
                                        }).addTo(window.map);
                                        
                                        // Store reference to the label marker
                                        labelMarkers.set(name, {
                                            marker: labelMarker,
                                            icon: labelIcon,
                                            active: false
                                        });
                                        
                                        // Add click event to the label for route planning
                                        labelMarker.on('click', function() {
                                            addWaypointToRoute(dotMarker, latitude, longitude, name, altitude);
                                        });
                                    }
                                }
                            }

                            // A brief timeout to ensure map renders properly after showing
                            setTimeout(function() {
                                window.map.invalidateSize();
                            }, 100);

                            // Update button state
                            document.getElementById("load-map").textContent =
                                "Map Loaded";
                        })
                        .catch((error) => {
                            console.error("Error loading KML:", error);
                            document.getElementById("load-map").textContent =
                                "Error Loading Map";
                            document.getElementById("load-map").disabled =
                                false;
                        });
                });
        </script>
    </body>
</html>